<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Messages</title>
</head>
<style>
html, body{
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body{
    display: flex;
    flex-direction: column;
    height: 100vh;
}
#mainDiv{
    flex: 1;
    background-color: silver;
}


#leftDiv{
    /* flex:auto; */
    flex-direction: column;
    float: left;
    width: 35%;
    border-radius: 8px;
    margin-left: 20px;
    margin-top: 20px;
    height: 590px;
    background-color: #FFFFFF;
}

#viewMessage{
    float: left;
    width: 61%;
    margin-top: 20px;
    margin-left: 20px;
    border-radius: 8px;
    height: 590px;
    background-color: #FFFFFF;
}

#messageLabel{
    margin-left: 150px;
    font-size: 23px;
    font-style: italic;
    width: 5vh;
    
}
#messageList{
    /* flex: 1; */
    margin-top: 5vh;
    height: 78vh;
    overflow-y: auto;
}

#senderContent > span:first-child{
    display: inline-block;
    margin-left: 10px;
    font-size: 30px;
}

#senderContent > span:nth-child(2){
    opacity: 0.7 !important;
    display: block;
    margin-left: 10px;
}

.eachMessage{
    display: block;
    width: 390px;
    overflow: hidden;
    transition: background-color 0.3s ease; 

}


.eachMessage :hover{
    background-color: bisque;
}

.displayImage{
    height: 60px;
    width: 60px;
    display: inline-block;
    border-radius: 50%;
}

#senderImage{
    padding-left: 10px;
    float:left;
    height: 100%;
}

#senderContent{
    padding-left: 10px;
    float: left;
    height: 100%;
}

#viewMessageHeader{
    float: left;
    width: 100%;
    height: 58px;
    border-bottom: 1px gray solid;
}

#viewMessageBody{
    float:left;
    width: 100%;
    height:85%;

}

.headerDisplayImage{
    height: 40px;
    width: 40px;
    /* display: inline-block; */
    border-radius: 50%;
    float: left;
    padding-left:12px;
    padding-top:12px;
}

.headerName{
    float: left;
}

#chatBody{
    float:left;
    width: 100%;
    height: 95%;
    border-bottom: 1px gray solid;
    overflow-y: scroll;
}

#chatOptions{
    float:left;
    width: 100%;
    height: 5%;

}

#messageText{
    width:76%;
    float:left;
    height:100%;
    margin-left: 18px;
    margin-top:18px;
    border-radius: 10%;
    border: none;
    background-color: bisque;
}

#sendMessageBtn{
    width: 15%;
    float: left;
    height: 100%;
    margin-left: 18px;
    color: #FFFFFF;
    margin-top:18px;
    border-radius: 10%;
}

</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<script type="text/javascript">

setInterval(()=>{
    if($('#messageText').val()==''){
       let currentUserId = $('#currentUserId').val();
       let currentChatUser = $('#currentChatUser').val();
       let maxMessageId = $('#maxMessageId').val();

       renderViewMessageBody(currentChatUser, currentUserId, maxMessageId);
    }
    
},3000);
// $('#senderContent').click(function(event){
//     const chatHeader = document.getElementById('viewMessageHeader');
//     chatHeader.innerHTML = '';

//     const imageSrc = document.createElement('img');
//     imageSrc.src=event.
// })

function senderContentClick(image, senderName, currentUserId){
       const chatHeader = document.getElementById('viewMessageHeader');
       chatHeader.innerHTML = '';

       const imageSrc = document.createElement('img');
       imageSrc.src=image;
       imageSrc.className='headerDisplayImage';
       chatHeader.appendChild(imageSrc);

       const span = document.createElement('span');
       span.textContent=senderName;
       span.className='headerName';
       chatHeader.appendChild(span);

       renderViewMessageBody(senderName, currentUserId, null);
}

function renderViewMessageBody(name, currentUserId, messageId){
    // let maxId = 0;
    $.ajax({
        url: '/getMessageBetweenUsers',
        method: 'GET',
        data:{
            name:name,
            messageId: messageId!=null?BigInt(messageId):null
        },
        success:function(data){
            $('#maxMessageId').val(data.maxId);

            // alert('inside id = ' + maxId)
            const chatBody = document.getElementById('chatBody');
            if(messageId==null){
                chatBody.innerHTML='';
            }
            
            console.log("data = " + data);

            let marginCount = 2;
            // for(const [key, value] of data.entries()){
            Object.entries(data.row).forEach(([key, value])=> {
                const outsideChatDiv = document.createElement('div');
                outsideChatDiv.style.width='100%';
                outsideChatDiv.style.display='block';
                outsideChatDiv.style.float='left';
                // outsideChatDiv.style.marginTop=''
                chatBody.appendChild(outsideChatDiv);
                const chatDiv = document.createElement('div');
                chatDiv.style.borderRadius='8%';
                chatDiv.style.display='inline-block';
                chatDiv.style.marginTop='5px';
                chatDiv.style.maxWidth='48%';
                chatDiv.style.overflowWrap='break-word';
                chatDiv.style.whiteSpace = 'normal';
                chatDiv.style.padding = '10px';
                Object.entries(value).forEach(([k, v])=> {  
                    let index = k.indexOf("Id");
                    let subId = k.substring(0,index);
                    if(subId==currentUserId){
                        chatDiv.style.textAlign= 'right';
                        chatDiv.style.backgroundColor="#2e8dd1"
                        chatDiv.style.color = '#FFFFFF'
                        chatDiv.style.float = 'right';
                        chatDiv.style.marginRight = '6px';
                    }else{
                        chatDiv.style.textAlign= 'left';
                        chatDiv.style.backgroundColor = '#d9dbde';
                        chatDiv.style.color = '#000000';
                        chatDiv.style.float = 'left';
                        chatDiv.style.marginLeft='6px';
                    }
                    chatDiv.textContent=v;
                });               
                outsideChatDiv.appendChild(chatDiv);
            });
                
            // }
        }
    })
    // alert('max id = ' + maxId);
    $('#currentChatUser').val(name);
    $('#currentUserId').val(currentUserId);

}

function sendMessage(){
    let message = $('#messageText').val();
    if(message==''){
        return;
    }
    let receiver = $('#currentChatUser').val()
    $.ajax({
        url:'/sendMessage',
        method: 'POST',
        data:{
            message,
            receiver
        },
        success:function(){
            // renderViewMessageBody(name,)
            appendChatDiv(message, 'success');


        },
        error:function(){
            appendChatDiv(message, 'fail');
        }
    })
}

function appendChatDiv(message, result){
        const chatBodyDiv = document.getElementById('chatBody');
        const outsideChatDiv = document.createElement('div');
        outsideChatDiv.style.width='100%';
        outsideChatDiv.style.display='block';
        outsideChatDiv.style.float='left';
        chatBodyDiv.appendChild(outsideChatDiv);

        const chatDiv = document.createElement('div');
        chatDiv.style.borderRadius='8%';
        chatDiv.style.display='inline-block';
        chatDiv.style.marginTop='5px';
        chatDiv.style.maxWidth='48%';
        chatDiv.style.overflowWrap='break-word';
        chatDiv.style.whiteSpace = 'normal';
        chatDiv.style.textAlign= 'right';
        chatDiv.style.backgroundColor="#2e8dd1"
        chatDiv.style.marginRight = '6px';
        chatDiv.style.padding = '10px';
        if(result=='fail'){
            chatDiv.style.color='#de1b31';
        }else{
            chatDiv.style.color = '#FFFFFF'
        }
        chatDiv.style.float = 'right';
        chatDiv.textContent = message;
        outsideChatDiv.appendChild(chatDiv);
        $('#messageText').val('');

        


}
</script>
<script src="/js/commonjs.js" type="text/javascript"></script>
<link href="/css/common.css?v=123" rel="stylesheet" type="text/css">
<body>
<div th:replace="header.html"></div>
<div id="mainDiv">

<div id="leftDiv">
<span id="messageLabel">Chat</span>
<div id="messageList">
        <div th:each="message : ${messageList}" class="eachMessage">
            <div id="senderImage">
                <img class="displayImage" th:src="${message.value.senderPicture}" th:alt="${message.value.senderName}"/>
            </div>
            <div id="senderContent" th:attr="data-sender-picture=${message.value.senderPicture}, data-sender=${message.value.senderName}, data-current-user-id=${session.userId}" onclick="senderContentClick(this.dataset.senderPicture, this.dataset.sender, this.dataset.currentUserId)">
                <span th:text="${message.value.senderName}"></span>
                <th:block th:each="entry, iter : ${message.value.allMessages.entrySet()}" >
                    <th:block th:if="${iter.index==0}" th:each="messageEntry : ${entry.value.entrySet()}">
                        <span th:text="${messageEntry.value}"></span>
                    </th:block>
                        <!-- <span th:if="${iter.index==0}" th:text="${entry.value}"></span> -->
                </th:block>
                <!-- <span th:text="${message.value.allMessages.value}"></span> -->
            </div>
        
        </div>
</div>
</div>
<div id="viewMessage">
    <div id="viewMessageHeader">
    </div>
    <div id="viewMessageBody">
        <div id="chatBody"></div>
        <div id="chatOptions">
            <input type="text" placeholder="Message" id="messageText"/>
            <input type="button" value="Send" id="sendMessageBtn" th:class="${'colour-' + (session.themeColour!=null?session.themeColour:'EAE21D')}" onclick="sendMessage()"/>
        </div>
    </div>
</div>
<input type="hidden" name="currentChatUser" id="currentChatUser" value=""/>
<input type="hidden" name="currentChatUserId" id="currentChatUserId" value=""/>
<input type="hidden" name="currentUserId" id="currentUserId" value=""/>
<input type="hidden" name="maxMessageId" id="maxMessageId" value=""/>
<div th:replace="menu.html"></div>
</div>
</body>
</html>